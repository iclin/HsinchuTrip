<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»æ–°ç«¹æ‰¾é›™é¹¿å¹é¢¨ä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* è«è˜­è¿ªé¢¨æ ¼è¼¸å…¥æ¡† - ç¨å¾®åŠ æ·±é‚Šæ¡†å¢å¼·å°æ¯” */
        .edit-input { 
            border: 2px solid #cbd5e1; 
            padding: 8px 12px; 
            border-radius: 12px; 
            width: 100%; 
            font-size: inherit; 
            background-color: #f8fafc; 
            color: #334155;
            transition: all 0.2s;
        }
        .edit-input:focus { 
            outline: none; 
            border-color: #64748b; 
            background-color: #ffffff;
            box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.2);
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(253, 252, 248, 0.95); display: flex; justify-content: center; align-items: center; z-index: 50; flex-direction: column; padding: 20px; text-align: center; }
    </style>
</head>
<body class="bg-[#F2F0E9] text-slate-700"> <!-- èƒŒæ™¯æ”¹ç‚ºç¨å¾®æ·±ä¸€é»çš„ç±³ç°ï¼Œå¢åŠ å±¤æ¬¡ -->
    <div id="root"></div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // â–¼â–¼â–¼ è«‹å°‡æ‚¨çš„ Firebase Config è²¼åœ¨ä¸‹æ–¹ â–¼â–¼â–¼
        // =================================================================
        
        // ğŸš¨ æ³¨æ„ï¼šè«‹ç¢ºä¿é€™è£¡å¡«å…¥çš„æ˜¯æ‚¨å¾ Firebase Console è¤‡è£½çš„çœŸå¯¦è³‡æ–™
        const firebaseConfig = {
            apiKey: "AIzaSyDQz_Zf7rWGoYD6iaVY1IjK3WL29bOL05E",
            authDomain: "myhsinchutrip.firebaseapp.com",
            projectId: "myhsinchutrip",
            storageBucket: "myhsinchutrip.firebasestorage.app",
            messagingSenderId: "231264929944",
            appId: "1:231264929944:web:4064e4a32ceae467a5a8ed",
            measurementId: "G-8KLB0RNLZC"
        };
        
        // =================================================================
        // â–²â–²â–² è¨­å®šçµæŸ â–²â–²â–²
        // =================================================================

        // æª¢æŸ¥æ˜¯å¦é‚„åœ¨ä½¿ç”¨é è¨­å€¼
        const isConfigured = firebaseConfig.projectId !== "your-project-id" && firebaseConfig.apiKey !== "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxx";

        if (isConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                
                window.db = db;
                window.doc = doc;
                window.setDoc = setDoc;
                window.onSnapshot = onSnapshot;
                window.isFirebaseConfigured = true;
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                window.firebaseInitError = e.message;
            }
        } else {
            window.isFirebaseConfigured = false;
        }

        // Trigger React render
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        // åˆå§‹é è¨­è³‡æ–™ (å·²ç§»é™¤é›»è©±æ¬„ä½)
        const INITIAL_DATA = {
            schedule: {
                "1": [
                    { "time": "11:30", "endTime": "13:30", "title": "åˆé¤ï¼šå¸¸åšæ–™ç†å»šæˆ¿", "description": "å·²è¨‚ä½ã€‚ç„¡èœå–®/å®¶å¸¸æ–™ç†ï¼Œå£å‘³æº«é¦¨ã€‚", "location": "æ–°ç«¹å¸‚åŒ—å€å…‰è¯è¡—102ä¹‹3è™Ÿ", "type": "food", "notes": "4ä½å¤§äºº (ç¨‹ã€å„’ã€èŠ³ã€å‘µ)", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=å¸¸åšæ–™ç†å»šæˆ¿" },
                    { "time": "13:45", "endTime": "15:30", "title": "ä¸‹åˆèŒ¶ï¼šæå…‹æ‰¿åšå£«æ•…å±… a-moom", "description": "æ—¥å¼å¤è¹Ÿæ”¹å»ºï¼Œæ°›åœéœè¬ï¼Œé©åˆèŠå¤©ã€‚æ‹›ç‰Œæ˜¯ç”Ÿåå¸èˆ‡å­£ç¯€ç”œé»ã€‚", "location": "æ–°ç«¹å¸‚åŒ—å€å‹åˆ©è·¯199è™Ÿ", "type": "coffee", "notes": "è·é›¢åˆé¤ç´„8åˆ†é˜è»Šç¨‹ã€‚", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=æå…‹æ‰¿åšå£«æ•…å±…+a-moom" },
                    { "time": "16:00", "endTime": "17:30", "title": "Check-inï¼šç…™æ³¢éƒ½æœƒé¤¨", "description": "è¾¦ç†å…¥ä½ï¼Œç¨å¾®æ•´ç†è¡Œæèˆ‡ä¼‘æ¯ã€‚", "location": "æ–°ç«¹å¸‚æ±å€æ°‘ç”Ÿè·¯177è™Ÿ", "type": "hotel", "notes": "åœè»Šå ´ä½æ–¼é£¯åº—B1-B3ã€‚", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=ç…™æ³¢å¤§é£¯åº—æ–°ç«¹éƒ½æœƒé¤¨" },
                    { "time": "17:30", "endTime": "18:00", "title": "åˆ†é ­è¡Œå‹•", "description": "å‘µï¼šæ¥å°å­©ã€‚\nå…¶ä»–ï¼šå‰å¾€å‘µå®¶ã€‚", "location": "ç§»å‹•ä¸­", "type": "transport", "notes": "", "googleMapLink": "" },
                    { "time": "18:30", "endTime": "21:30", "title": "æ™šä¸Šèšæœƒï¼šå‘µçš„æ–°å®¶", "description": "ä¸²é–€å­æ™‚é–“ï¼", "location": "æ–°ç«¹å¸‚åŒ—å€ä¸­å±±è·¯431å··66è™Ÿ", "type": "home", "notes": "", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=æ–°ç«¹å¸‚åŒ—å€ä¸­å±±è·¯431å··66è™Ÿ" }
                ],
                "2": [
                    { "time": "09:00", "endTime": "10:30", "title": "é£¯åº—æ—©é¤", "description": "Buffet æ™‚é–“ã€‚", "location": "ç…™æ³¢å¤§é£¯åº—", "type": "food", "notes": "", "googleMapLink": "" },
                    { "time": "10:30", "endTime": "11:20", "title": "å‰å¾€åŒ—åŸ”", "description": "è‡ªé§•å‰å¾€ã€‚", "location": "è·¯ç¨‹ç´„ 40 åˆ†é˜", "type": "transport", "notes": "èµ°å°68ç·šæ¥å°3ç·šã€‚", "googleMapLink": "https://www.google.com/maps/dir/ç…™æ³¢å¤§é£¯åº—æ–°ç«¹éƒ½æœƒé¤¨/åŒ—åŸ”è€è¡—" },
                    { "time": "11:30", "endTime": "12:30", "title": "å®¢å®¶æ“‚èŒ¶", "description": "æ¨è–¦ï¼šä¸‰åä¹è™ŸåŒ—åŸ”æ“‚èŒ¶", "location": "åŒ—åŸ”è€è¡—", "type": "activity", "notes": "é«”é©—ç£¨èŒ¶æ¨‚è¶£ã€‚", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=ä¸‰åä¹è™ŸåŒ—åŸ”æ“‚èŒ¶" },
                    { "time": "12:30", "endTime": "14:00", "title": "è€è¡—åˆé¤", "description": "ç²„æ¢ã€é¹¹è±¬è‚‰ã€‚", "location": "åŒ—åŸ”è€è¡—", "type": "food", "notes": "", "googleMapLink": "" },
                    { "time": "14:00", "endTime": "15:30", "title": "å¤è¹Ÿæ•£æ­¥", "description": "é‡‘å»£ç¦å…¬é¤¨ã€å§œé˜¿æ–°æ´‹æ¨“ã€‚", "location": "åŒ—åŸ”è€è¡—å‘¨é‚Š", "type": "walk", "notes": "", "googleMapLink": "" }
                ]
            },
            expenses: []
        };

        const Icons = {
            MapPin: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Coffee: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Home: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Navigation: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Clock: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Utensils: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
            Car: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M14 14h6"/></svg>,
            Info: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Users: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Moon: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
            Sun: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
            Edit: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Save: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            X: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Dollar: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Trash: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Plus: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Sync: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Wrench: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Link: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>,
            ArrowRight: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        };

        const SetupScreen = () => (
            <div className="loading-overlay">
                <div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full">
                    <div className="text-slate-500 mb-4 flex justify-center">
                        <Icons.Wrench size={48} />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">å°šæœªè¨­å®š Firebase é‡‘é‘°</h2>
                    <p className="text-slate-600 mb-6 text-sm">
                        è«‹ä½¿ç”¨è¨˜äº‹æœ¬æˆ–ç¨‹å¼ç¢¼ç·¨è¼¯å™¨é–‹å•Ÿæ­¤ HTML æª”æ¡ˆï¼Œä¸¦åœ¨ç¨‹å¼ç¢¼ç´„ç¬¬ 30 è¡Œè™•ï¼Œå¡«å…¥æ‚¨è‡ªå·±çš„ <code>firebaseConfig</code>ã€‚
                    </p>
                    <div className="bg-slate-50 p-4 rounded text-left text-xs font-mono text-slate-600 overflow-x-auto mb-6 border border-slate-200">
                        <pre>{`const firebaseConfig = {
    apiKey: "å–ä»£æˆ‘...",
    authDomain: "å–ä»£æˆ‘...",
    projectId: "å–ä»£æˆ‘...",
    // ...å…¶ä»–æ¬„ä½
};`}</pre>
                    </div>
                    <a href="https://console.firebase.google.com/" target="_blank" className="block w-full bg-[#64748b] text-white py-3 rounded-lg font-bold hover:bg-[#475569] transition">
                        å‰å¾€ Firebase Console å–å¾—é‡‘é‘°
                    </a>
                </div>
            </div>
        );

        const ErrorScreen = ({ error }) => (
            <div className="loading-overlay">
                <div className="bg-white p-6 rounded-xl shadow-xl max-w-md w-full">
                     <div className="text-red-400 mb-2 flex justify-center">
                        <Icons.X size={40} />
                    </div>
                    <h3 className="text-lg font-bold text-slate-800">é€£ç·šéŒ¯èª¤</h3>
                    <p className="text-slate-600 text-sm mt-2">{error}</p>
                    <p className="text-xs text-slate-400 mt-4">è«‹æª¢æŸ¥æ‚¨çš„ Firebase Config æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å®‰å…¨è¦å‰‡æ˜¯å¦å·²é–‹å•Ÿç‚ºæ¸¬è©¦æ¨¡å¼ã€‚</p>
                </div>
            </div>
        );

        const ExpenseTracker = ({ expenses, travelers, onUpdateExpenses, isSyncing }) => {
            const [newTitle, setNewTitle] = React.useState('');
            const [newAmount, setNewAmount] = React.useState('');
            const [payer, setPayer] = React.useState(travelers[0]);
            const [beneficiaries, setBeneficiaries] = React.useState(travelers);
            const [showForm, setShowForm] = React.useState(false);

            const handleAdd = () => {
                if (!newTitle || !newAmount) return alert('è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡');
                if (beneficiaries.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤äºº');
                
                const newExpense = {
                    id: Date.now(),
                    title: newTitle,
                    amount: parseInt(newAmount),
                    payer: payer,
                    beneficiaries: beneficiaries,
                    date: new Date().toLocaleDateString()
                };

                onUpdateExpenses([...expenses, newExpense]);
                setNewTitle('');
                setNewAmount('');
                setBeneficiaries(travelers);
                setShowForm(false);
            };

            const handleDelete = (id) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) {
                    onUpdateExpenses(expenses.filter(e => e.id !== id));
                }
            };

            const toggleBeneficiary = (name) => {
                if (beneficiaries.includes(name)) {
                    setBeneficiaries(beneficiaries.filter(b => b !== name));
                } else {
                    setBeneficiaries([...beneficiaries, name]);
                }
            };

            const calculateSettlement = () => {
                let balances = {};
                travelers.forEach(t => balances[t] = 0);
                let totalSpent = 0;

                expenses.forEach(e => {
                    totalSpent += e.amount;
                    balances[e.payer] += e.amount;
                    const splitAmount = e.amount / e.beneficiaries.length;
                    e.beneficiaries.forEach(b => {
                        balances[b] -= splitAmount;
                    });
                });

                let debtors = [];
                let creditors = [];
                Object.entries(balances).forEach(([name, amount]) => {
                    if (amount < -1) debtors.push({ name, amount });
                    if (amount > 1) creditors.push({ name, amount });
                });

                debtors.sort((a, b) => a.amount - b.amount);
                creditors.sort((a, b) => b.amount - a.amount);

                let transactions = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debit = Math.abs(debtors[i].amount);
                    let credit = creditors[j].amount;
                    let amount = Math.min(debit, credit);

                    transactions.push({
                        from: debtors[i].name,
                        to: creditors[j].name,
                        amount: Math.round(amount)
                    });

                    debtors[i].amount += amount;
                    creditors[j].amount -= amount;

                    if (Math.abs(debtors[i].amount) < 1) i++;
                    if (Math.abs(creditors[j].amount) < 1) j++;
                }

                return { balances, totalSpent, transactions };
            };

            const { balances, totalSpent, transactions } = calculateSettlement();

            return (
                <div className="space-y-6">
                    {/* è¨˜å¸³å¡ç‰‡ - ä½¿ç”¨æ·±æµ·è—ç° */}
                    <div className="bg-[#6B8E9B] rounded-2xl p-6 text-white shadow-md relative overflow-hidden">
                        {isSyncing && <div className="absolute top-2 right-2 animate-spin"><Icons.Sync size={16} className="text-white/60"/></div>}
                        <div className="text-blue-50/80 text-sm mb-1 font-medium tracking-wide">ç¸½æ”¯å‡º</div>
                        <div className="text-4xl font-bold mb-6 tracking-tight text-white">${totalSpent.toLocaleString()}</div>
                        <div className="flex space-x-3 overflow-x-auto scrollbar-hide pb-2">
                            {travelers.map(t => (
                                <div key={t} className="flex-shrink-0 bg-white/20 px-4 py-2 rounded-xl text-xs backdrop-blur-sm border border-white/20 min-w-[80px]">
                                    <div className="opacity-90 mb-1 font-bold text-white">{t}</div>
                                    <div className={`font-bold text-lg ${balances[t] >= 0 ? 'text-[#eefcf2]' : 'text-[#fff1f2]'}`}>
                                        {balances[t] >= 0 ? `+${Math.round(balances[t])}` : Math.round(balances[t])}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* å»ºè­°çµç®—æ–¹å¼ */}
                    {transactions.length > 0 && (
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <h3 className="font-bold text-slate-700 mb-3 flex items-center">
                                <Icons.Dollar className="mr-2 text-[#D68C6D]" size={18}/> å»ºè­°çµç®—æ–¹å¼
                            </h3>
                            <div className="space-y-3">
                                {transactions.map((t, idx) => (
                                    <div key={idx} className="flex justify-between items-center text-sm bg-slate-50 p-2.5 rounded-xl border border-slate-100">
                                        <div className="flex items-center space-x-2">
                                            <span className="font-bold text-slate-700 bg-white px-2 py-1 rounded shadow-sm">{t.from}</span>
                                            <span className="text-slate-400 text-xs">çµ¦</span>
                                            <span className="font-bold text-slate-700 bg-white px-2 py-1 rounded shadow-sm">{t.to}</span>
                                        </div>
                                        <div className="flex items-center text-[#D68C6D] font-bold">
                                            ${t.amount}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    <button onClick={() => setShowForm(!showForm)} className="w-full py-3 bg-[#D68C6D] text-white rounded-xl font-bold shadow-sm hover:bg-[#c57d60] transition flex items-center justify-center transform active:scale-[0.98]">
                        {showForm ? 'å–æ¶ˆæ–°å¢' : 'â• æ–°å¢æ”¯å‡º'}
                    </button>

                    {showForm && (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 animate-fade-in">
                            <div className="space-y-4">
                                <input placeholder="é …ç›® (å¦‚ï¼šåˆé¤)" className="edit-input" value={newTitle} onChange={e => setNewTitle(e.target.value)}/>
                                <div className="flex space-x-3">
                                    <input type="number" placeholder="é‡‘é¡" className="edit-input flex-1" value={newAmount} onChange={e => setNewAmount(e.target.value)}/>
                                    <select className="edit-input flex-1 cursor-pointer" value={payer} onChange={e => setPayer(e.target.value)}>
                                        {travelers.map(t => <option key={t} value={t}>{t} ä»˜çš„</option>)}
                                    </select>
                                </div>
                                <div className="pt-1">
                                    <div className="text-xs text-slate-400 mb-2">åˆ†æ”¤çµ¦ï¼š</div>
                                    <div className="flex flex-wrap gap-2">
                                        {travelers.map(t => (
                                            <button key={t} onClick={() => toggleBeneficiary(t)} className={`px-3 py-1.5 rounded-full text-xs font-medium transition-colors ${beneficiaries.includes(t) ? 'bg-[#D68C6D] text-white shadow-sm' : 'bg-slate-100 text-slate-400'}`}>
                                                {t} {beneficiaries.includes(t) && 'âœ“'}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <button onClick={handleAdd} className="w-full bg-[#6B8E9B] text-white py-2.5 rounded-lg font-bold text-sm hover:bg-[#5a7d8a] transition">ç¢ºèªæ–°å¢</button>
                            </div>
                        </div>
                    )}

                    <div className="space-y-3">
                        <h3 className="font-bold text-slate-500 text-sm ml-1">æ”¯å‡ºæ˜ç´°</h3>
                        {expenses.length === 0 ? (
                            <div className="text-center text-slate-300 py-8 text-sm">ç›®å‰é‚„æ²’æœ‰ç´€éŒ„å–”</div>
                        ) : (
                            expenses.slice().reverse().map(item => (
                                <div key={item.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-start hover:shadow-md transition group">
                                    <div>
                                        <div className="font-bold text-slate-700 text-lg">{item.title}</div>
                                        <div className="text-xs text-slate-500 mt-1 flex flex-col gap-1">
                                            <span>
                                                <span className="font-medium text-slate-700">{item.payer}</span> å…ˆä»˜äº† 
                                                <span className="text-[#D68C6D] font-bold mx-1">${item.amount}</span>
                                            </span>
                                            <span className="text-slate-400">
                                                (å¹« {item.beneficiaries.join(', ')} ä»˜)
                                            </span>
                                        </div>
                                    </div>
                                    <button onClick={() => handleDelete(item.id)} className="text-slate-300 hover:text-red-400 p-2 transition-colors"><Icons.Trash size={18}/></button>
                                </div>
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
          const [activeTab, setActiveTab] = React.useState('schedule');
          const [activeDay, setActiveDay] = React.useState(1);
          const [isEditing, setIsEditing] = React.useState(false);
          const [data, setData] = React.useState(null);
          const [isSyncing, setIsSyncing] = React.useState(false);
          const [firebaseReady, setFirebaseReady] = React.useState(false);
          const [configError, setConfigError] = React.useState(false);
          const [initError, setInitError] = React.useState(null);

          // Listen for Firebase initialization
          React.useEffect(() => {
              const handleFirebaseReady = () => {
                  if (window.isFirebaseConfigured) {
                      setFirebaseReady(true);
                      if (window.firebaseInitError) {
                          setInitError(window.firebaseInitError);
                      }
                  } else {
                      setConfigError(true);
                  }
              };
              
              window.addEventListener('firebase-ready', handleFirebaseReady);
              // Handle case where event fired before React mounted
              if (window.isFirebaseConfigured !== undefined) {
                  handleFirebaseReady();
              }
              
              return () => window.removeEventListener('firebase-ready', handleFirebaseReady);
          }, []);

          // Sync with Firestore
          React.useEffect(() => {
              if (!firebaseReady || !window.db) return;
              
              try {
                  const tripDocRef = window.doc(window.db, "trips", "hsinchu_trip_v1");
                  
                  const unsubscribe = window.onSnapshot(tripDocRef, (docSnap) => {
                      if (docSnap.exists()) {
                          setData(docSnap.data());
                      } else {
                          // First time setup: create doc
                          window.setDoc(tripDocRef, INITIAL_DATA);
                          setData(INITIAL_DATA);
                      }
                      setIsSyncing(false);
                  }, (error) => {
                      console.error("Firestore Error:", error);
                      setInitError("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡‘é‘°æ¬Šé™ (" + error.code + ")");
                  });
                  
                  return () => unsubscribe();
              } catch (e) {
                  console.error("Setup Error:", e);
                  setInitError(e.message);
              }
          }, [firebaseReady]);

          const saveData = async (newData) => {
              setData(newData); // Optimistic update
              setIsSyncing(true);
              try {
                  const tripDocRef = window.doc(window.db, "trips", "hsinchu_trip_v1");
                  await window.setDoc(tripDocRef, newData);
              } catch (e) {
                  console.error("Error updating document: ", e);
                  alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ Firebase è¨­å®š");
              }
              setIsSyncing(false);
          };

          const updateScheduleItem = (day, index, field, value) => {
            const newData = JSON.parse(JSON.stringify(data));
            newData.schedule[day][index][field] = value;
            if (field === 'location') {
                if (value && value.trim() !== "") {
                    newData.schedule[day][index].googleMapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(value)}`;
                } else {
                    newData.schedule[day][index].googleMapLink = "";
                }
            }
            saveData(newData);
          };

          const addScheduleItem = (day) => {
              const newData = JSON.parse(JSON.stringify(data));
              const newItem = {
                  time: "12:00",
                  endTime: "",
                  title: "æ–°è¡Œç¨‹",
                  description: "è«‹è¼¸å…¥èªªæ˜",
                  location: "",
                  type: "scene",
                  notes: "",
                  googleMapLink: ""
              };
              newData.schedule[day].push(newItem);
              saveData(newData);
              setTimeout(() => {
                  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
              }, 100);
          };

          const deleteScheduleItem = (day, index) => {
              if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;
              const newData = JSON.parse(JSON.stringify(data));
              newData.schedule[day].splice(index, 1);
              saveData(newData);
          };

          const updateExpenses = (newExpenses) => {
              saveData({ ...data, expenses: newExpenses });
          };

          const travelers = ["ç¨‹", "å„’", "èŠ³", "å‘µ"];
          const day2Travelers = ["ç¨‹", "å„’", "èŠ³"];
          
          if (configError) return <SetupScreen />;
          if (initError) return <ErrorScreen error={initError} />;
          if (!data) return <div className="loading-overlay flex-col"><div className="animate-spin text-[#6B8E9B] mb-2"><Icons.Sync size={40}/></div><div className="text-slate-400 text-sm">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div></div>;

          return (
            <div className="min-h-screen pb-24 relative overflow-hidden bg-[#F2F0E9]">
              
              {/* Header: è«è˜­è¿ªæ·±æµ·è—ç°é…è‰² */}
              <div className="bg-[#6B8E9B] text-white p-6 shadow-sm sticky top-0 z-20 rounded-b-[2rem] relative overflow-hidden transition-all duration-500">
                
                <div className="flex justify-between items-start mb-4 relative z-10 px-2">
                    <div className="pt-1">
                        <h1 className="text-xl font-bold tracking-wide text-white drop-shadow-sm">
                            å»æ–°ç«¹æ‰¾é›™é¹¿
                            <br/>
                            <span className="text-lg font-medium opacity-90">å¹é¢¨ä¹‹æ—… ğŸ¦ŒğŸ’¨</span>
                        </h1>
                        <div className="mt-2 inline-block px-3 py-1 rounded-full bg-white/20 backdrop-blur-md border border-white/10">
                           <span className="text-[11px] font-medium tracking-wider text-white/90">1/23 - 1/24 â€¢ å¿«æ¨‚å››äººè¡Œ</span>
                        </div>
                    </div>
                    {activeTab === 'schedule' && (
                        <button onClick={() => setIsEditing(!isEditing)} className={`p-2.5 rounded-full transition-all duration-300 shadow-sm border border-white/20 ${isEditing ? 'bg-[#D68C6D] text-white rotate-90' : 'bg-white/20 text-white hover:bg-white/30'}`}>
                            {isEditing ? <Icons.X size={18} /> : <Icons.Edit size={18} />}
                        </button>
                    )}
                </div>

                <div className="mt-6 flex space-x-4 relative z-10 px-1">
                    <button onClick={() => setActiveTab('schedule')} className={`flex-1 py-2.5 rounded-xl text-xs font-bold transition-all flex justify-center items-center shadow-sm ${activeTab === 'schedule' ? 'bg-white text-[#6B8E9B] translate-y-0.5' : 'bg-[#506d7d] text-white/70 hover:bg-[#455e6b]'}`}>
                        <Icons.MapPin size={14} className="mr-1.5"/> è¡Œç¨‹
                    </button>
                    <button onClick={() => setActiveTab('money')} className={`flex-1 py-2.5 rounded-xl text-xs font-bold transition-all flex justify-center items-center shadow-sm ${activeTab === 'money' ? 'bg-white text-[#6B8E9B] translate-y-0.5' : 'bg-[#506d7d] text-white/70 hover:bg-[#455e6b]'}`}>
                        <Icons.Dollar size={14} className="mr-1.5"/> è¨˜å¸³
                    </button>
                </div>

                {activeTab === 'schedule' && (
                    <div className="mt-4 flex space-x-3 relative z-10 px-1 pb-2">
                        <button onClick={() => setActiveDay(1)} className={`flex-1 py-2 rounded-lg text-[11px] font-bold transition-all border ${activeDay === 1 ? 'bg-[#D68C6D] border-[#D68C6D] text-white shadow-sm' : 'bg-transparent border-white/30 text-white/60 hover:bg-white/10'}`}>Day 1 (é€±äº”)</button>
                        <button onClick={() => setActiveDay(2)} className={`flex-1 py-2 rounded-lg text-[11px] font-bold transition-all border ${activeDay === 2 ? 'bg-[#D68C6D] border-[#D68C6D] text-white shadow-sm' : 'bg-transparent border-white/30 text-white/60 hover:bg-white/10'}`}>Day 2 (é€±å…­)</button>
                    </div>
                )}
                
                {isSyncing && <div className="absolute top-3 left-1/2 -translate-x-1/2 bg-slate-800/40 px-3 py-1 rounded-full text-[10px] backdrop-blur-md text-white flex items-center border border-white/10"><Icons.Sync size={10} className="mr-1.5 animate-spin"/> åŒæ­¥ä¸­...</div>}
              </div>

              {isEditing && activeTab === 'schedule' && <div className="bg-[#fff1f0] border-b border-[#ffccc7] p-2.5 text-[#cf1322] text-xs text-center font-medium sticky top-[210px] z-10 shadow-sm tracking-wide">âœï¸ ç·¨è¼¯æ¨¡å¼ä¸­</div>}

              <div className="max-w-md mx-auto p-5 relative">
                
                {activeTab === 'money' && <ExpenseTracker expenses={data.expenses} travelers={travelers} onUpdateExpenses={updateExpenses} isSyncing={isSyncing}/>}
                
                {activeTab === 'schedule' && (
                    <div className="space-y-6 pb-20">
                        <div className="relative border-l-2 border-slate-300 ml-3 space-y-10 mt-6">
                        {data.schedule[activeDay].map((item, index) => (
                            <div key={index} className="relative pl-8 group">
                            {/* æ™‚é–“è»¸åœ“é» */}
                            <div className={`absolute -left-[7px] top-1 w-3.5 h-3.5 rounded-full border-2 border-[#F2F0E9] transition-colors ${index % 2 === 0 ? 'bg-[#6B8E9B]' : 'bg-[#D68C6D]'} shadow-sm`}></div>
                            
                            <div className={`bg-white rounded-2xl shadow-[0_2px_10px_-3px_rgba(0,0,0,0.05)] border overflow-hidden transition-all duration-300 hover:shadow-md ${isEditing ? 'border-[#D68C6D] ring-2 ring-[#fff1f0]' : 'border-slate-100'}`}>
                                <div className="p-5 relative">
                                    
                                {isEditing && (
                                    <button 
                                        onClick={() => deleteScheduleItem(activeDay, index)} 
                                        className="absolute top-3 right-3 text-slate-300 hover:text-red-400 p-1.5 hover:bg-red-50 rounded-full transition"
                                        title="åˆªé™¤"
                                    >
                                        <Icons.Trash size={16} />
                                    </button>
                                )}

                                {/* æ™‚é–“èˆ‡ç®­é ­ */}
                                <div className="flex items-center mb-3">
                                    <div className="flex items-center text-[#6B8E9B] font-bold text-base bg-[#f0f7f4] px-2 py-1 rounded-md">
                                        <Icons.Clock className="mr-1.5" size={14} />
                                        {isEditing ? (
                                            <div className="flex items-center space-x-1">
                                                <input type="text" value={item.time} onChange={(e) => updateScheduleItem(activeDay, index, 'time', e.target.value)} className="bg-transparent w-12 text-center border-b border-[#6B8E9B] focus:outline-none"/>
                                                <span className="text-slate-400 font-light mx-1">â†’</span>
                                                <input type="text" value={item.endTime || ''} onChange={(e) => updateScheduleItem(activeDay, index, 'endTime', e.target.value)} className="bg-transparent w-12 text-center border-b border-[#6B8E9B] focus:outline-none" placeholder="çµæŸ"/>
                                            </div>
                                        ) : (
                                            <span className="tracking-wide text-sm">{item.time} {item.endTime && <span className="text-slate-400 font-light mx-1">â†’</span>} {item.endTime}</span>
                                        )}
                                    </div>
                                </div>

                                {/* æ¨™é¡Œ */}
                                <h3 className="text-lg font-bold text-slate-700 mb-2 pr-8 leading-snug">
                                    {isEditing ? <input type="text" value={item.title} onChange={(e) => updateScheduleItem(activeDay, index, 'title', e.target.value)} className="edit-input font-bold" placeholder="è¡Œç¨‹æ¨™é¡Œ"/> : item.title}
                                </h3>

                                {/* æè¿° */}
                                <div className="text-slate-500 text-sm mb-4 leading-relaxed whitespace-pre-line bg-[#f8fafc] p-3 rounded-xl border border-slate-100">
                                    {isEditing ? <textarea value={item.description} onChange={(e) => updateScheduleItem(activeDay, index, 'description', e.target.value)} className="edit-input min-h-[60px]" placeholder="è¡Œç¨‹èªªæ˜"/> : item.description}
                                </div>

                                {/* åœ°é»èˆ‡é€£çµ */}
                                {(item.location && item.location !== "ç§»å‹•ä¸­" || isEditing) && (
                                    <div className="flex flex-col text-xs text-slate-500 mb-4 bg-[#f1f5f9] p-3 rounded-xl border border-slate-200">
                                        <div className="flex items-start">
                                            <Icons.MapPin size={14} className="mr-2 mt-0.5 flex-shrink-0 text-[#6B8E9B]" />
                                            {isEditing ? <input type="text" value={item.location} onChange={(e) => updateScheduleItem(activeDay, index, 'location', e.target.value)} className="edit-input text-xs py-1" placeholder="åœ°å€"/> : <span className="font-medium text-slate-600">{item.location}</span>}
                                        </div>
                                        {isEditing && (
                                            <div className="flex items-center mt-3 pl-6 border-t border-slate-200 pt-2">
                                                <Icons.Link size={12} className="mr-1.5 flex-shrink-0 text-slate-400" />
                                                <input 
                                                    type="text" 
                                                    value={item.googleMapLink || ''} 
                                                    onChange={(e) => updateScheduleItem(activeDay, index, 'googleMapLink', e.target.value)} 
                                                    className="bg-transparent w-full text-xs text-slate-400 focus:outline-none placeholder:text-slate-300" 
                                                    placeholder="å°èˆªé€£çµ"
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* å°èˆªæŒ‰éˆ• */}
                                {!isEditing && item.googleMapLink && (
                                    <a href={item.googleMapLink} target="_blank" rel="noreferrer" className="block w-full bg-[#6B8E9B] text-white text-center py-2.5 rounded-xl text-sm font-bold shadow-sm hover:bg-[#5a7d8a] transition-all transform active:scale-[0.98] flex items-center justify-center">
                                        <Icons.Navigation size={16} className="mr-2 opacity-90" />
                                        <span>å°èˆª</span>
                                    </a>
                                )}
                                </div>
                            </div>
                            </div>
                        ))}
                        </div>
                        
                        {isEditing && (
                            <button 
                                onClick={() => addScheduleItem(activeDay)}
                                className="w-full py-4 mt-8 bg-white border border-dashed border-[#6B8E9B] text-[#6B8E9B] rounded-2xl font-bold hover:bg-[#f0f7f4] transition flex items-center justify-center group"
                            >
                                <div className="bg-[#f0f7f4] p-1.5 rounded-full mr-2 group-hover:scale-110 transition-transform">
                                   <Icons.Plus className="" size={18} />
                                </div>
                                æ–°å¢è¡Œç¨‹
                            </button>
                        )}
                    </div>
                )}
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>