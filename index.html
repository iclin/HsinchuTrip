<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»æ–°ç«¹æ‰¾é›™é¹¿å¹é¢¨ä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .edit-input { border: 2px solid #fdba74; padding: 6px 10px; border-radius: 8px; width: 100%; font-size: inherit; background-color: #fff7ed; }
        .edit-input:focus { outline: none; border-color: #f97316; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; justify-content: center; align-items: center; z-index: 50; flex-direction: column; padding: 20px; text-align: center; }
        
        /* è²¼åœ–å‹•ç•«æ•ˆæœ */
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        .sticker { animation: float 3s ease-in-out infinite; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.1)); }
    </style>
</head>
<body class="bg-yellow-50"> <!-- èƒŒæ™¯æ”¹ç‚ºæº«æš–çš„æ·ºé»ƒè‰² -->
    <div id="root"></div>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // =================================================================
        // â–¼â–¼â–¼ è«‹å°‡æ‚¨çš„ Firebase Config è²¼åœ¨ä¸‹æ–¹ â–¼â–¼â–¼
        // =================================================================
        
        // ğŸš¨ æ³¨æ„ï¼šè«‹ç¢ºä¿é€™è£¡å¡«å…¥çš„æ˜¯æ‚¨å¾ Firebase Console è¤‡è£½çš„çœŸå¯¦è³‡æ–™
        const firebaseConfig = {
            apiKey: "AIzaSyDQz_Zf7rWGoYD6iaVY1IjK3WL29bOL05E",
            authDomain: "myhsinchutrip.firebaseapp.com",
            projectId: "myhsinchutrip",
            storageBucket: "myhsinchutrip.firebasestorage.app",
            messagingSenderId: "231264929944",
            appId: "1:231264929944:web:4064e4a32ceae467a5a8ed",
            measurementId: "G-8KLB0RNLZC"
        };
        
        // =================================================================
        // â–²â–²â–² è¨­å®šçµæŸ â–²â–²â–²
        // =================================================================

        // æª¢æŸ¥æ˜¯å¦é‚„åœ¨ä½¿ç”¨é è¨­å€¼
        const isConfigured = firebaseConfig.projectId !== "your-project-id" && firebaseConfig.apiKey !== "AIzaSyDxxxxxxxxxxxxxxxxxxxxxxxx";

        if (isConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                
                window.db = db;
                window.doc = doc;
                window.setDoc = setDoc;
                window.onSnapshot = onSnapshot;
                window.isFirebaseConfigured = true;
            } catch (e) {
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                window.firebaseInitError = e.message;
            }
        } else {
            window.isFirebaseConfigured = false;
        }

        // Trigger React render
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        // åˆå§‹é è¨­è³‡æ–™ (å·²ç§»é™¤é›»è©±æ¬„ä½)
        const INITIAL_DATA = {
            schedule: {
                "1": [
                    { "time": "11:30", "endTime": "13:30", "title": "åˆé¤ï¼šå¸¸åšæ–™ç†å»šæˆ¿", "description": "å·²è¨‚ä½ã€‚ç„¡èœå–®/å®¶å¸¸æ–™ç†ï¼Œå£å‘³æº«é¦¨ã€‚", "location": "æ–°ç«¹å¸‚åŒ—å€å…‰è¯è¡—102ä¹‹3è™Ÿ", "type": "food", "notes": "4ä½å¤§äºº (ç¨‹ã€å„’ã€èŠ³ã€å‘µ)", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=å¸¸åšæ–™ç†å»šæˆ¿" },
                    { "time": "13:45", "endTime": "15:30", "title": "ä¸‹åˆèŒ¶ï¼šæå…‹æ‰¿åšå£«æ•…å±… a-moom", "description": "æ—¥å¼å¤è¹Ÿæ”¹å»ºï¼Œæ°›åœéœè¬ï¼Œé©åˆèŠå¤©ã€‚æ‹›ç‰Œæ˜¯ç”Ÿåå¸èˆ‡å­£ç¯€ç”œé»ã€‚", "location": "æ–°ç«¹å¸‚åŒ—å€å‹åˆ©è·¯199è™Ÿ", "type": "coffee", "notes": "è·é›¢åˆé¤ç´„8åˆ†é˜è»Šç¨‹ã€‚", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=æå…‹æ‰¿åšå£«æ•…å±…+a-moom" },
                    { "time": "16:00", "endTime": "17:30", "title": "Check-inï¼šç…™æ³¢éƒ½æœƒé¤¨", "description": "è¾¦ç†å…¥ä½ï¼Œç¨å¾®æ•´ç†è¡Œæèˆ‡ä¼‘æ¯ã€‚", "location": "æ–°ç«¹å¸‚æ±å€æ°‘ç”Ÿè·¯177è™Ÿ", "type": "hotel", "notes": "åœè»Šå ´ä½æ–¼é£¯åº—B1-B3ã€‚", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=ç…™æ³¢å¤§é£¯åº—æ–°ç«¹éƒ½æœƒé¤¨" },
                    { "time": "17:30", "endTime": "18:00", "title": "åˆ†é ­è¡Œå‹•", "description": "å‘µï¼šæ¥å°å­©ã€‚\nå…¶ä»–ï¼šå‰å¾€å‘µå®¶ã€‚", "location": "ç§»å‹•ä¸­", "type": "transport", "notes": "", "googleMapLink": "" },
                    { "time": "18:30", "endTime": "21:30", "title": "æ™šä¸Šèšæœƒï¼šå‘µçš„æ–°å®¶", "description": "ä¸²é–€å­æ™‚é–“ï¼", "location": "æ–°ç«¹å¸‚åŒ—å€ä¸­å±±è·¯431å··66è™Ÿ", "type": "home", "notes": "", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=æ–°ç«¹å¸‚åŒ—å€ä¸­å±±è·¯431å··66è™Ÿ" }
                ],
                "2": [
                    { "time": "09:00", "endTime": "10:30", "title": "é£¯åº—æ—©é¤", "description": "Buffet æ™‚é–“ã€‚", "location": "ç…™æ³¢å¤§é£¯åº—", "type": "food", "notes": "", "googleMapLink": "" },
                    { "time": "10:30", "endTime": "11:20", "title": "å‰å¾€åŒ—åŸ”", "description": "è‡ªé§•å‰å¾€ã€‚", "location": "è·¯ç¨‹ç´„ 40 åˆ†é˜", "type": "transport", "notes": "èµ°å°68ç·šæ¥å°3ç·šã€‚", "googleMapLink": "https://www.google.com/maps/dir/ç…™æ³¢å¤§é£¯åº—æ–°ç«¹éƒ½æœƒé¤¨/åŒ—åŸ”è€è¡—" },
                    { "time": "11:30", "endTime": "12:30", "title": "å®¢å®¶æ“‚èŒ¶", "description": "æ¨è–¦ï¼šä¸‰åä¹è™ŸåŒ—åŸ”æ“‚èŒ¶", "location": "åŒ—åŸ”è€è¡—", "type": "activity", "notes": "é«”é©—ç£¨èŒ¶æ¨‚è¶£ã€‚", "googleMapLink": "https://www.google.com/maps/search/?api=1&query=ä¸‰åä¹è™ŸåŒ—åŸ”æ“‚èŒ¶" },
                    { "time": "12:30", "endTime": "14:00", "title": "è€è¡—åˆé¤", "description": "ç²„æ¢ã€é¹¹è±¬è‚‰ã€‚", "location": "åŒ—åŸ”è€è¡—", "type": "food", "notes": "", "googleMapLink": "" },
                    { "time": "14:00", "endTime": "15:30", "title": "å¤è¹Ÿæ•£æ­¥", "description": "é‡‘å»£ç¦å…¬é¤¨ã€å§œé˜¿æ–°æ´‹æ¨“ã€‚", "location": "åŒ—åŸ”è€è¡—å‘¨é‚Š", "type": "walk", "notes": "", "googleMapLink": "" }
                ]
            },
            expenses: []
        };

        const Icons = {
            MapPin: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            Coffee: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>,
            Home: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Navigation: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>,
            Clock: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Utensils: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>,
            Car: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/><path d="M14 14h6"/></svg>,
            Info: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            Users: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Moon: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
            Sun: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
            Edit: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Save: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            X: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Dollar: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Trash: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Plus: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Sync: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Wrench: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Link: (p)=><svg {...p} width={p.size||18} height={p.size||18} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        };

        const SetupScreen = () => (
            <div className="loading-overlay">
                <div className="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full">
                    <div className="text-orange-500 mb-4 flex justify-center">
                        <Icons.Wrench size={48} />
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-2">å°šæœªè¨­å®š Firebase é‡‘é‘°</h2>
                    <p className="text-gray-600 mb-6 text-sm">
                        è«‹ä½¿ç”¨è¨˜äº‹æœ¬æˆ–ç¨‹å¼ç¢¼ç·¨è¼¯å™¨é–‹å•Ÿæ­¤ HTML æª”æ¡ˆï¼Œä¸¦åœ¨ç¨‹å¼ç¢¼ç´„ç¬¬ 30 è¡Œè™•ï¼Œå¡«å…¥æ‚¨è‡ªå·±çš„ <code>firebaseConfig</code>ã€‚
                    </p>
                    <div className="bg-gray-100 p-4 rounded text-left text-xs font-mono text-gray-700 overflow-x-auto mb-6">
                        <pre>{`const firebaseConfig = {
    apiKey: "å–ä»£æˆ‘...",
    authDomain: "å–ä»£æˆ‘...",
    projectId: "å–ä»£æˆ‘...",
    // ...å…¶ä»–æ¬„ä½
};`}</pre>
                    </div>
                    <a href="https://console.firebase.google.com/" target="_blank" className="block w-full bg-teal-600 text-white py-3 rounded-lg font-bold hover:bg-teal-700 transition">
                        å‰å¾€ Firebase Console å–å¾—é‡‘é‘°
                    </a>
                </div>
            </div>
        );

        const ErrorScreen = ({ error }) => (
            <div className="loading-overlay">
                <div className="bg-white p-6 rounded-xl shadow-xl max-w-md w-full">
                     <div className="text-red-500 mb-2 flex justify-center">
                        <Icons.X size={40} />
                    </div>
                    <h3 className="text-lg font-bold text-gray-800">é€£ç·šéŒ¯èª¤</h3>
                    <p className="text-gray-600 text-sm mt-2">{error}</p>
                    <p className="text-xs text-gray-400 mt-4">è«‹æª¢æŸ¥æ‚¨çš„ Firebase Config æ˜¯å¦æ­£ç¢ºï¼Œæˆ–æ˜¯å®‰å…¨è¦å‰‡æ˜¯å¦å·²é–‹å•Ÿç‚ºæ¸¬è©¦æ¨¡å¼ã€‚</p>
                </div>
            </div>
        );

        // --- è²¼åœ–å…ƒä»¶ ---
        const Sticker = ({ children, className }) => (
            <div className={`absolute select-none pointer-events-none sticker ${className}`} style={{zIndex: 0}}>
                <div className="bg-white p-1 rounded-full shadow-md border-2 border-white">
                   <div className="text-2xl">{children}</div>
                </div>
            </div>
        );

        const ExpenseTracker = ({ expenses, travelers, onUpdateExpenses, isSyncing }) => {
            const [newTitle, setNewTitle] = React.useState('');
            const [newAmount, setNewAmount] = React.useState('');
            const [payer, setPayer] = React.useState(travelers[0]);
            const [beneficiaries, setBeneficiaries] = React.useState(travelers);
            const [showForm, setShowForm] = React.useState(false);

            const handleAdd = () => {
                if (!newTitle || !newAmount) return alert('è«‹è¼¸å…¥é …ç›®èˆ‡é‡‘é¡');
                if (beneficiaries.length === 0) return alert('è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤äºº');
                
                const newExpense = {
                    id: Date.now(),
                    title: newTitle,
                    amount: parseInt(newAmount),
                    payer: payer,
                    beneficiaries: beneficiaries,
                    date: new Date().toLocaleDateString()
                };

                onUpdateExpenses([...expenses, newExpense]);
                setNewTitle('');
                setNewAmount('');
                setBeneficiaries(travelers);
                setShowForm(false);
            };

            const handleDelete = (id) => {
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) {
                    onUpdateExpenses(expenses.filter(e => e.id !== id));
                }
            };

            const toggleBeneficiary = (name) => {
                if (beneficiaries.includes(name)) {
                    setBeneficiaries(beneficiaries.filter(b => b !== name));
                } else {
                    setBeneficiaries([...beneficiaries, name]);
                }
            };

            const calculateSettlement = () => {
                let balances = {};
                travelers.forEach(t => balances[t] = 0);
                let totalSpent = 0;

                expenses.forEach(e => {
                    totalSpent += e.amount;
                    balances[e.payer] += e.amount;
                    const splitAmount = e.amount / e.beneficiaries.length;
                    e.beneficiaries.forEach(b => {
                        balances[b] -= splitAmount;
                    });
                });

                let debtors = [];
                let creditors = [];
                Object.entries(balances).forEach(([name, amount]) => {
                    if (amount < -1) debtors.push({ name, amount });
                    if (amount > 1) creditors.push({ name, amount });
                });

                debtors.sort((a, b) => a.amount - b.amount);
                creditors.sort((a, b) => b.amount - a.amount);

                let transactions = [];
                let i = 0, j = 0;
                while (i < debtors.length && j < creditors.length) {
                    let debit = Math.abs(debtors[i].amount);
                    let credit = creditors[j].amount;
                    let amount = Math.min(debit, credit);

                    transactions.push({
                        from: debtors[i].name,
                        to: creditors[j].name,
                        amount: Math.round(amount)
                    });

                    debtors[i].amount += amount;
                    creditors[j].amount -= amount;

                    if (Math.abs(debtors[i].amount) < 1) i++;
                    if (Math.abs(creditors[j].amount) < 1) j++;
                }

                return { balances, totalSpent, transactions };
            };

            const { balances, totalSpent, transactions } = calculateSettlement();

            return (
                <div className="space-y-6">
                    <div className="bg-gradient-to-r from-orange-400 to-pink-500 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                        {isSyncing && <div className="absolute top-2 right-2 animate-spin"><Icons.Sync size={16} className="text-white/50"/></div>}
                        <div className="text-orange-50 text-sm mb-1 font-medium">ç¸½æ”¯å‡º</div>
                        <div className="text-4xl font-extrabold mb-6">${totalSpent.toLocaleString()}</div>
                        <div className="flex space-x-3 overflow-x-auto scrollbar-hide pb-2">
                            {travelers.map(t => (
                                <div key={t} className="flex-shrink-0 bg-white/20 px-4 py-2 rounded-xl text-xs backdrop-blur-sm border border-white/10">
                                    <div className="opacity-90 mb-1 font-bold">{t}</div>
                                    <div className={`font-black text-lg ${balances[t] >= 0 ? 'text-green-200' : 'text-yellow-200'}`}>
                                        {balances[t] >= 0 ? `+${Math.round(balances[t])}` : Math.round(balances[t])}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <button onClick={() => setShowForm(!showForm)} className="w-full py-3 bg-indigo-500 text-white rounded-xl font-bold shadow hover:bg-indigo-600 transition flex items-center justify-center transform hover:scale-[1.02]">
                        {showForm ? 'å–æ¶ˆæ–°å¢' : 'â• æ–°å¢æ”¯å‡º'}
                    </button>

                    {showForm && (
                        <div className="bg-white p-4 rounded-xl shadow-lg border-2 border-indigo-100 animate-fade-in">
                            <div className="space-y-3">
                                <input placeholder="é …ç›® (å¦‚ï¼šåˆé¤)" className="edit-input bg-gray-50" value={newTitle} onChange={e => setNewTitle(e.target.value)}/>
                                <div className="flex space-x-2">
                                    <input type="number" placeholder="é‡‘é¡" className="edit-input flex-1 bg-gray-50" value={newAmount} onChange={e => setNewAmount(e.target.value)}/>
                                    <select className="edit-input flex-1 bg-gray-50" value={payer} onChange={e => setPayer(e.target.value)}>
                                        {travelers.map(t => <option key={t} value={t}>{t} ä»˜çš„</option>)}
                                    </select>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    {travelers.map(t => (
                                        <button key={t} onClick={() => toggleBeneficiary(t)} className={`px-3 py-1 rounded-full text-xs border ${beneficiaries.includes(t) ? 'bg-indigo-100 text-indigo-700 border-indigo-200' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                            {t} {beneficiaries.includes(t) && 'âœ“'}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={handleAdd} className="w-full bg-indigo-600 text-white py-2 rounded-lg font-bold text-sm">ç¢ºèª</button>
                            </div>
                        </div>
                    )}

                    <div className="space-y-3">
                        {expenses.slice().reverse().map(item => (
                            <div key={item.id} className="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center hover:shadow-md transition">
                                <div>
                                    <div className="font-bold text-gray-800 text-lg">{item.title}</div>
                                    <div className="text-xs text-gray-500 mt-1">{item.payer} ä»˜ <span className="text-indigo-600 font-bold">${item.amount}</span></div>
                                </div>
                                <button onClick={() => handleDelete(item.id)} className="text-gray-300 hover:text-red-400 p-2"><Icons.Trash size={18}/></button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
          const [activeTab, setActiveTab] = React.useState('schedule');
          const [activeDay, setActiveDay] = React.useState(1);
          const [isEditing, setIsEditing] = React.useState(false);
          const [data, setData] = React.useState(null);
          const [isSyncing, setIsSyncing] = React.useState(false);
          const [firebaseReady, setFirebaseReady] = React.useState(false);
          const [configError, setConfigError] = React.useState(false);
          const [initError, setInitError] = React.useState(null);

          // Listen for Firebase initialization
          React.useEffect(() => {
              const handleFirebaseReady = () => {
                  if (window.isFirebaseConfigured) {
                      setFirebaseReady(true);
                      if (window.firebaseInitError) {
                          setInitError(window.firebaseInitError);
                      }
                  } else {
                      setConfigError(true);
                  }
              };
              
              window.addEventListener('firebase-ready', handleFirebaseReady);
              // Handle case where event fired before React mounted
              if (window.isFirebaseConfigured !== undefined) {
                  handleFirebaseReady();
              }
              
              return () => window.removeEventListener('firebase-ready', handleFirebaseReady);
          }, []);

          // Sync with Firestore
          React.useEffect(() => {
              if (!firebaseReady || !window.db) return;
              
              try {
                  const tripDocRef = window.doc(window.db, "trips", "hsinchu_trip_v1");
                  
                  const unsubscribe = window.onSnapshot(tripDocRef, (docSnap) => {
                      if (docSnap.exists()) {
                          setData(docSnap.data());
                      } else {
                          // First time setup: create doc
                          window.setDoc(tripDocRef, INITIAL_DATA);
                          setData(INITIAL_DATA);
                      }
                      setIsSyncing(false);
                  }, (error) => {
                      console.error("Firestore Error:", error);
                      setInitError("ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡‘é‘°æ¬Šé™ (" + error.code + ")");
                  });
                  
                  return () => unsubscribe();
              } catch (e) {
                  console.error("Setup Error:", e);
                  setInitError(e.message);
              }
          }, [firebaseReady]);

          const saveData = async (newData) => {
              setData(newData); // Optimistic update
              setIsSyncing(true);
              try {
                  const tripDocRef = window.doc(window.db, "trips", "hsinchu_trip_v1");
                  await window.setDoc(tripDocRef, newData);
              } catch (e) {
                  console.error("Error updating document: ", e);
                  alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ˜¯ Firebase è¨­å®š");
              }
              setIsSyncing(false);
          };

          const updateScheduleItem = (day, index, field, value) => {
            // ä½¿ç”¨ JSON parse/stringify é€²è¡Œæ·±æ‹·è²ï¼Œé¿å…ç›´æ¥ä¿®æ”¹ state
            const newData = JSON.parse(JSON.stringify(data));
            newData.schedule[day][index][field] = value;
            
            // è‡ªå‹•æ›´æ–°å°èˆªé€£çµ
            if (field === 'location') {
                if (value && value.trim() !== "") {
                    newData.schedule[day][index].googleMapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(value)}`;
                } else {
                    newData.schedule[day][index].googleMapLink = "";
                }
            }
            
            saveData(newData);
          };

          const addScheduleItem = (day) => {
              // ä½¿ç”¨æ·±æ‹·è²
              const newData = JSON.parse(JSON.stringify(data));
              const newItem = {
                  time: "12:00",
                  endTime: "",
                  title: "æ–°è¡Œç¨‹",
                  description: "è«‹è¼¸å…¥èªªæ˜",
                  location: "",
                  type: "scene",
                  notes: "",
                  googleMapLink: ""
              };
              newData.schedule[day].push(newItem);
              saveData(newData);
              // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨æ–¹ä¾¿ç·¨è¼¯
              setTimeout(() => {
                  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
              }, 100);
          };

          const deleteScheduleItem = (day, index) => {
              if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) return;
              // ä½¿ç”¨æ·±æ‹·è²
              const newData = JSON.parse(JSON.stringify(data));
              newData.schedule[day].splice(index, 1);
              saveData(newData);
          };

          const updateExpenses = (newExpenses) => {
              saveData({ ...data, expenses: newExpenses });
          };

          const travelers = ["ç¨‹", "å„’", "èŠ³", "å‘µ"];
          const day2Travelers = ["ç¨‹", "å„’", "èŠ³"];
          
          if (configError) return <SetupScreen />;
          if (initError) return <ErrorScreen error={initError} />;
          if (!data) return <div className="loading-overlay flex-col"><div className="animate-spin text-teal-600 mb-2"><Icons.Sync size={40}/></div><div className="text-gray-500 text-sm">æ­£åœ¨é€£ç·šé›²ç«¯è³‡æ–™åº«...</div></div>;

          return (
            <div className="min-h-screen pb-24 relative overflow-hidden">
              
              {/* Header */}
              <div className="bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-6 shadow-lg sticky top-0 z-20 rounded-b-3xl relative overflow-hidden">
                {/* èƒŒæ™¯è£é£¾è²¼åœ– */}
                <Sticker className="top-2 right-4 rotate-12">ğŸ’¨</Sticker>
                <Sticker className="bottom-2 left-6 -rotate-12 scale-75">ğŸ¦Œ</Sticker>
                
                <div className="flex justify-between items-start mb-2 relative z-10">
                    <div>
                        <h1 className="text-2xl font-black tracking-tight drop-shadow-md">
                            å»æ–°ç«¹æ‰¾é›™é¹¿
                            <br/>
                            <span className="text-xl">å¹é¢¨ä¹‹æ—… ğŸ¦ŒğŸ’¨</span>
                        </h1>
                        <div className="mt-1 flex items-center text-cyan-100 text-xs font-bold bg-white/20 inline-block px-2 py-1 rounded-full backdrop-blur-sm">
                           <span>1/23 - 1/24 â€¢ å¿«æ¨‚å››äººè¡Œ</span>
                        </div>
                    </div>
                    {activeTab === 'schedule' && (
                        <button onClick={() => setIsEditing(!isEditing)} className={`p-2 rounded-full transition-colors shadow-md ${isEditing ? 'bg-orange-500 text-white animate-pulse' : 'bg-white text-blue-600 hover:bg-blue-50'}`}>
                            {isEditing ? <Icons.X size={20} /> : <Icons.Edit size={20} />}
                        </button>
                    )}
                </div>

                <div className="mt-5 flex space-x-3 relative z-10">
                    <button onClick={() => setActiveTab('schedule')} className={`flex-1 py-2 rounded-2xl text-sm font-bold transition-all flex justify-center items-center shadow-sm ${activeTab === 'schedule' ? 'bg-white text-blue-600 scale-105' : 'bg-blue-800/30 text-blue-100 hover:bg-blue-700/40'}`}>
                        <Icons.MapPin size={16} className="mr-1"/> è¡Œç¨‹
                    </button>
                    <button onClick={() => setActiveTab('money')} className={`flex-1 py-2 rounded-2xl text-sm font-bold transition-all flex justify-center items-center shadow-sm ${activeTab === 'money' ? 'bg-white text-pink-600 scale-105' : 'bg-blue-800/30 text-blue-100 hover:bg-blue-700/40'}`}>
                        <Icons.Dollar size={16} className="mr-1"/> è¨˜å¸³
                    </button>
                </div>

                {activeTab === 'schedule' && (
                    <div className="mt-4 flex space-x-2 relative z-10">
                        <button onClick={() => setActiveDay(1)} className={`flex-1 py-1.5 rounded-xl text-xs font-bold transition-all ${activeDay === 1 ? 'bg-yellow-400 text-blue-900 shadow ring-2 ring-yellow-200' : 'bg-white/20 text-white'}`}>Day 1 (é€±å››)</button>
                        <button onClick={() => setActiveDay(2)} className={`flex-1 py-1.5 rounded-xl text-xs font-bold transition-all ${activeDay === 2 ? 'bg-yellow-400 text-blue-900 shadow ring-2 ring-yellow-200' : 'bg-white/20 text-white'}`}>Day 2 (é€±äº”)</button>
                    </div>
                )}
                
                {isSyncing && <div className="absolute top-2 left-1/2 -translate-x-1/2 bg-black/30 px-3 py-1 rounded-full text-[10px] backdrop-blur text-white flex items-center"><Icons.Sync size={10} className="mr-1 animate-spin"/> åŒæ­¥ä¸­...</div>}
              </div>

              {isEditing && activeTab === 'schedule' && <div className="bg-orange-100 border-b-2 border-orange-300 p-2 text-orange-800 text-xs text-center font-bold sticky top-[180px] z-10 shadow-sm">âœï¸ ç·¨è¼¯æ¨¡å¼ä¸­ï¼šç›¡æƒ…ä¿®æ”¹è¡Œç¨‹å§ï¼</div>}

              <div className="max-w-md mx-auto p-4 relative">
                
                {/* å…§å®¹å€è£é£¾è²¼åœ– */}
                {activeTab === 'schedule' && activeDay === 1 && (
                     <Sticker className="top-10 right-0 rotate-6 opacity-80 scale-75">â˜•</Sticker>
                )}
                {activeTab === 'schedule' && activeDay === 2 && (
                     <Sticker className="top-20 left-0 -rotate-12 opacity-80 scale-75">â˜€ï¸</Sticker>
                )}

                {activeTab === 'money' && <ExpenseTracker expenses={data.expenses} travelers={travelers} onUpdateExpenses={updateExpenses} isSyncing={isSyncing}/>}
                
                {activeTab === 'schedule' && (
                    <div className="space-y-6 pb-12">
                        <div className="relative border-l-4 border-blue-200 ml-3 space-y-8 mt-4">
                        {data.schedule[activeDay].map((item, index) => (
                            <div key={index} className="relative pl-6 group">
                            <div className="absolute -left-[11px] top-0 w-5 h-5 rounded-full bg-blue-400 border-4 border-white shadow-sm group-hover:bg-yellow-400 transition-colors"></div>
                            <div className={`bg-white rounded-2xl shadow-sm border-2 overflow-hidden transition-all duration-300 hover:shadow-lg hover:-translate-y-1 ${isEditing ? 'border-orange-300 ring-2 ring-orange-100' : 'border-white'}`}>
                                <div className="p-5 relative">
                                    
                                {isEditing && (
                                    <button 
                                        onClick={() => deleteScheduleItem(activeDay, index)} 
                                        className="absolute top-2 right-2 text-gray-300 hover:text-red-500 p-2 hover:bg-red-50 rounded-full transition"
                                        title="åˆªé™¤æ­¤è¡Œç¨‹"
                                    >
                                        <Icons.Trash size={18} />
                                    </button>
                                )}

                                <div className="flex justify-between items-start mb-2 space-x-2 mr-6">
                                    <div className="flex items-center text-blue-600 font-black text-lg w-full">
                                    <Icons.Clock className="mr-1 flex-shrink-0" size={18} />
                                    {isEditing ? (
                                        <div className="flex items-center space-x-1 w-full">
                                            <input type="text" value={item.time} onChange={(e) => updateScheduleItem(activeDay, index, 'time', e.target.value)} className="edit-input w-20 text-center font-bold text-gray-700"/>
                                            <span className="text-gray-400 font-bold">-</span>
                                            <input type="text" value={item.endTime || ''} onChange={(e) => updateScheduleItem(activeDay, index, 'endTime', e.target.value)} className="edit-input w-20 text-center font-bold text-gray-700" placeholder="çµæŸ"/>
                                        </div>
                                    ) : (
                                        <>{item.time} {item.endTime && <span className="text-xs text-gray-400 ml-2 font-bold tracking-wider">â” {item.endTime}</span>}</>
                                    )}
                                    </div>
                                </div>
                                <h3 className="text-xl font-bold text-gray-800 mb-2 flex items-center pr-6 leading-tight">
                                    {isEditing ? <input type="text" value={item.title} onChange={(e) => updateScheduleItem(activeDay, index, 'title', e.target.value)} className="edit-input font-bold text-lg" placeholder="è¡Œç¨‹æ¨™é¡Œ"/> : item.title}
                                </h3>
                                <div className="text-gray-600 text-sm mb-4 leading-relaxed whitespace-pre-line bg-gray-50/50 p-2 rounded-lg">
                                    {isEditing ? <textarea value={item.description} onChange={(e) => updateScheduleItem(activeDay, index, 'description', e.target.value)} className="edit-input" placeholder="è¡Œç¨‹èªªæ˜"/> : item.description}
                                </div>
                                {(item.location && item.location !== "ç§»å‹•ä¸­" || isEditing) && (
                                    <div className="flex flex-col text-xs text-gray-500 mb-3 bg-blue-50 p-3 rounded-xl">
                                        <div className="flex items-start">
                                            <Icons.MapPin size={14} className="mr-1.5 mt-0.5 flex-shrink-0 text-blue-400" />
                                            {isEditing ? <input type="text" value={item.location} onChange={(e) => updateScheduleItem(activeDay, index, 'location', e.target.value)} className="edit-input bg-white text-xs w-full" placeholder="åœ°å€ (è¼¸å…¥å¾Œä¸‹æ–¹è‡ªå‹•ç”¢ç”Ÿé€£çµ)"/> : <span className="font-medium text-blue-800">{item.location}</span>}
                                        </div>
                                        {isEditing && (
                                            <div className="flex items-center mt-2 pl-5">
                                                <Icons.Link size={12} className="mr-1 flex-shrink-0 text-blue-400" />
                                                <input 
                                                    type="text" 
                                                    value={item.googleMapLink || ''} 
                                                    onChange={(e) => updateScheduleItem(activeDay, index, 'googleMapLink', e.target.value)} 
                                                    className="edit-input bg-white text-xs text-blue-600 w-full" 
                                                    placeholder="å°èˆªé€£çµ (å¯æ‰‹å‹•è²¼ä¸Š)"
                                                />
                                            </div>
                                        )}
                                    </div>
                                )}
                                {!isEditing && item.googleMapLink && (
                                    <a href={item.googleMapLink} target="_blank" rel="noreferrer" className="block w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-center py-3 rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5 flex items-center justify-center group-hover:scale-[1.02]">
                                        <Icons.Navigation size={18} className="mr-2" />
                                        <span>é–‹å§‹å°èˆª</span>
                                    </a>
                                )}
                                </div>
                            </div>
                            </div>
                        ))}
                        </div>
                        
                        {isEditing && (
                            <button 
                                onClick={() => addScheduleItem(activeDay)}
                                className="w-full py-4 bg-white border-2 border-dashed border-cyan-300 text-cyan-600 rounded-2xl font-bold hover:bg-cyan-50 shadow-sm transition flex items-center justify-center mb-8"
                            >
                                <div className="bg-cyan-100 p-2 rounded-full mr-2">
                                   <Icons.Plus className="" size={20} />
                                </div>
                                æ–°å¢ä¸€å€‹è¡Œç¨‹
                            </button>
                        )}
                    </div>
                )}
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>